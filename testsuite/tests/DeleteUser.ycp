/**
 * File:
 *  DeleteUser.ycp
 *
 * Module:
 *  Users configurator
 *
 * Summary:
 *  Saving user tests.
 *
 * Authors:
 *  Jiri Suchomel <jsuchome@suse.cz>
 *
 */

{

    include "testsuite.ycp";
    map I_READ = $[
	"target" : $[
	    "size" : -1,
	    "tmpdir" : "/tmp/",
	    "yast2" : nil,
	],
	"sysconfig" : $[
	    "console" : $[
		"CONSOLE_FONT" : "",
		"CONSOLE_SCREENMAP" : "",
		"CONSOLE_UNICODEMAP" : "",
		"CONSOLE_MAGIC" : "",
		"CONSOLE_ENCODING" : "",
	    ],
	    "language" : $[
		"RC_LANG" : "",
		"DEFAULT_LANGUAGE" : "",
	    ],
	],
	"etc" : $[
	    "install_inf" : $[
		"Cmdline" : "",
		"InstMode" : nil,
	    ],
	],
	"probe" : $[
	    "architecture" : "i386",
	    "has_apm" : true,
	    "has_pcmcia" : false,
	    "has_smp" : false,
	    "system" : [],
	    "memory" : [],
	    "cpu" : [],
	    "cdrom" : $[
		"manual" : [],
	    ],
	    "floppy" : $[
		"manual" : [],
	    ],
	],
    ];
    map I_WRITE = $[];
    map I_EXEC = $[];
    TESTSUITE_INIT ([I_READ, I_WRITE, I_EXEC], 0);

    import "Users";
    import "UsersCache";

    Users::user_in_work = $["create_home":true,
	"forename":"",
	"fullname":"",
	"gid":100,
	"groupname": "users",
	"grouplist":"audio",
	"home":"/home/aaa",
	"org_home":"/home/aaa",
	"password":"$1$T8$yEI1SH.1b0jqeqDq6bHha1",
	"shadow":$["inact":-1, "max":99999, "min":0, "warn":7],
	"shell":"/bin/bash",
	"surname":"",
	"uid":500,
	"username":"aaa",
	"type":"local",
	"what":"delete_user"];

    Users::users_by_name ["local" ] = $[ "aaa": 500 ];

    Users::users ["local"] = $[
        500:  $[ "forename":"",
	"fullname":"",
	"gid":100,
	"groupname":"users",
	"grouplist":"audio",
	"home":"/home/aaa",
	"org_home":"/home/aaa",
	"password":"$1$T8$yEI1SH.1b0jqeqDq6bHha1",
	"shadow":$["inact":-1, "max":99999, "min":0, "warn":7],
	"shell":"/bin/bash",
	"surname":"",
	"uid":500,
	"username":"aaa",
	"type":"local"]
    ];

    Users::shadow = $[
        "local" : $[
            "aaa":  $[
                "inact":-1,
                "max":99999,
                "password": "qwerty",
                "min":0,
                "warn":7]
        ]
    ];

    Users::groups ["local" ] = $[
        100: $[ "groupname": "users", "userlist":"", "more_users": "hh,aaa","type": "local" ],
        17:  $[ "groupname": "audio", "userlist":"aaa,hh", "more_users": "","type": "local" ]
    ];

    Users::groups_by_name = $[
     "local": $[
        "users" : $[ "gid": 100, "groupname": "users", "userlist":"", "more_users": "hh,aaa", "type": "local" ]
      ],
      "system": $[
        "audio" : $[ "gid": 17, "groupname": "audio", "userlist":"aaa,hh", "more_users": "", "type": "local" ]
      ]
    ];

    UsersCache::users_itemlists ["local"] =
        [`item (`id (500), "aaa", "", "500", "users,audio")];

    DUMP ( sformat ("local user itemlist:\n %1",
        UsersCache::users_itemlists [ "local" ]:[]) );

    DUMP ( sformat ("local groups:\n %1\n", Users::groups [ "local" ]:$[]) );

    DUMP ( sformat ("local users:\n %1", Users::users [ "local" ]:$[]) );

    DUMP ("==================== running delete ======================");

    TEST(``(Users::Commit ("user", true)), [], 0);

    DUMP ( sformat ("local users modified:\n %1",
        Users::users [ "local" ]:$[]) );

    DUMP ( sformat ("local groups modified:\n %1\n",
        Users::groups [ "local" ]:$[]) );

    DUMP ( sformat ("local user itemlist modified:\n %1",
        UsersCache::users_itemlists [ "local" ]:[]) );

}
