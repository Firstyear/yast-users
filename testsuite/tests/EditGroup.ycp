{

    include "testsuite.ycp";
    map I_READ = $[
	"target" : $[
	    "size" : -1,
	    "tmpdir" : "/tmp/",
	    "yast2" : nil,
	],
	"sysconfig" : $[
	    "console" : $[
		"CONSOLE_FONT" : "",
		"CONSOLE_SCREENMAP" : "",
		"CONSOLE_UNICODEMAP" : "",
		"CONSOLE_MAGIC" : "",
		"CONSOLE_ENCODING" : "",
	    ],
	    "language" : $[
		"RC_LANG" : "",
		"DEFAULT_LANGUAGE" : "",
	    ],
	],
	"etc" : $[
	    "install_inf" : $[
		"Cmdline" : "",
		"InstMode" : nil,
	    ],
	],
	"probe" : $[
	    "architecture" : "i386",
	    "has_apm" : true,
	    "has_pcmcia" : false,
	    "has_smp" : false,
	    "system" : [],
	    "memory" : [],
	    "cpu" : [],
	    "cdrom" : $[
		"manual" : [],
	    ],
	    "floppy" : $[
		"manual" : [],
	    ],
	],
    ];
    map I_WRITE = $[];
    map I_EXEC = $[
	"target" : $[
	    "bash_output" : $[],
	],
    ];
    TESTSUITE_INIT ([I_READ, I_WRITE, I_EXEC], 0);

    import "Users";
    import "UsersCache";

    Users::groups ["local"] = $[
        501: $[
	    "gid":501,
            "groupname": "testgroup",
	    "userlist":"",
            "more_users":"cc",
	    "password":"x",
            "type":"local"
        ]
	];
    Users::groups_by_name ["local"] = $[
        "testgroup": $[
	    "gid":501,
            "groupname": "testgroup",
	    "userlist":"",
            "more_users":"cc",
	    "password":"x",
            "type":"local"
        ]
    ];

    Users::gshadow ["local"] = $[
        "testgroup": $[]];

    Users::users ["local"] = $[
        510: $[         // cc - default group is testgroup
            "forename":"",
            "fullname":"",
	    "gid":501,
            "groupname":"testgroup",
	    "grouplist":"audio",
	    "home":"/home/cc",
	    "org_home":"/home/cc",
	    "password":"x",
	    "shadow":$[
            "inact":-1, "max":99999, "min":0, "warn":7 ],
	    "shell":"/bin/bash",
	    "surname":"",
	    "uid":500,
	    "username":"cc",
            "type":"local"],
        520: $[         // ab - nothing with testgroup
            "forename":"",
            "fullname":"",
	    "gid":100,
            "groupname":"users",
	    "grouplist":"audio",
	    "home":"/home/ab",
	    "org_home":"/home/ab",
	    "password":"x",
	    "shadow":$[
            "inact":-1, "max":99999, "min":0, "warn":7 ],
	    "shell":"/bin/bash",
	    "surname":"",
	    "uid":500,
	    "username":"ab",
            "type":"local"],
    ];

    Users::users_by_name ["local" ] = $[
        "cc": 510,
        "ab": 520
    ];


    DUMP ( sformat ("current state of testgroup:\n %1",
        Users::groups ["local", 501]:$[]) );
    DUMP ("==========================================================");

    DUMP ( sformat ("user \"cc\" has testgroup as default group:\n %1",
        Users::users ["local", 510]:$[]) );
    DUMP ("==========================================================");

    DUMP ( sformat ("user \"ab\" has nothing to do with testgroup now:\n %1",
        Users::users ["local", 520]:$[]) );
    DUMP ("==========================================================");

    DUMP ( "testgroup was modified:");
    DUMP ( "\t - changed gid: 501 -> 777");
    DUMP ( "\t - changed groupname: testgroup -> testgroup_changed");
    DUMP ( "\t - changed userlist: added user \"ab\"");
    DUMP ("==========================================================");
    // changed gid, name, added "ab"
    Users::group_in_work = $[
        "org_gid": 501,
	"gid":777,
        "org_groupname": "testgroup",
        "groupname": "testgroup_changed",
	"userlist":"ab",
        "more_users":"cc",
	"password":"x",
        "type":"local",
	"what":"edit_group"
    ];

    DUMP ("===== Commiting change... ================================");
    DUMP ("==========================================================");

    TEST(``(Users::Commit ("group", false)), [], 0);

    DUMP ( sformat ("changed map of local groups:\n %1",
        Users::groups ["local"]:$[]) );
    DUMP ("==========================================================");

    DUMP ( sformat ("user \"cc\":\n %1",
        Users::users ["local", 510]:$[]) );
    DUMP ("==========================================================");

    DUMP ( sformat ("user \"ab\":\n %1",
        Users::users ["local", 520]:$[]) );


}
