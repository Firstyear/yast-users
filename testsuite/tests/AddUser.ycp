/**
 * File:
 *  AddUser.ycp
 *
 * Module:
 *  Users configurator
 *
 * Summary:
 *  Saving user tests.
 *
 * Authors:
 *  Jiri Suchomel <jsuchome@suse.cz>
 *
 */

{

    include "testsuite.ycp";
    map I_READ = $[
	"target" : $[
	    "size" : -1,
	    "tmpdir" : "/tmp/",
	    "yast2" : nil,
	],
	"sysconfig" : $[
	    "console" : $[
		"CONSOLE_FONT" : "",
		"CONSOLE_SCREENMAP" : "",
		"CONSOLE_UNICODEMAP" : "",
		"CONSOLE_MAGIC" : "",
		"CONSOLE_ENCODING" : "",
	    ],
	    "language" : $[
		"RC_LANG" : "",
		"DEFAULT_LANGUAGE" : "",
	    ],
	],
	"etc" : $[
	    "install_inf" : $[
		"Cmdline" : "",
		"InstMode" : nil,
	    ],
	],
	"probe" : $[
	    "architecture" : "i386",
	    "has_apm" : true,
	    "has_pcmcia" : false,
	    "has_smp" : false,
	    "system" : [],
	    "memory" : [],
	    "cpu" : [],
	    "cdrom" : $[
		"manual" : [],
	    ],
	    "floppy" : $[
		"manual" : [],
	    ],
	],
    ];
    map I_WRITE = $[];
    map I_EXEC = $[
	"target" : $[
	    "bash_output" : $[],
	],
    ];
    TESTSUITE_INIT ([I_READ, I_WRITE, I_EXEC], 0);

    import "Users";
    import "UsersCache";

    Users::user_in_work = $["create_home":true,
	"forename":"",
	"fullname":"",
	"gid":100,
    "groupname": "users",
	"grouplist":"audio",
	"home":"/home/aaa",
	"org_home":"/home/aaa",
	"password":"$1$T8$yEI1SH.1b0jqeqDq6bHha1",
	"shadow":$["inact":-1, "max":99999, "min":0, "warn":7],
	"shell":"/bin/bash",
	"surname":"",
	"uid":500,
	"username":"aaa",
    "type":"local",
	"what":"add_user"];

    Users::users_by_name = $["local": $[], "ldap":$[], "system":$[]];

    DUMP ( sformat ("local users:\n %1", Users::users [ "local" ]:$[]) );
    DUMP ( sformat ("shadow:\n %1\n", Users::shadow) );

    // without any groups present:
    TEST(``(Users::Commit ("user", false)), [], 0);

    DUMP ( sformat ("shadow:\n %1\n", Users::shadow) );

    DUMP ( sformat ("local users:\n %1", Users::users [ "local" ]:$[]) );

    DUMP ("==========================================================");

    // groups are ok:
    Users::groups ["local" ] = $[
        100: $[ "groupname": "users", "userlist":"", "more_users": "hh","type": "local" ],
        17:  $[ "groupname": "audio", "userlist":"hh", "more_users": "","type": "local" ]
    ];

    Users::groups_by_name = $[
     "local": $[
        "users" : $[ "gid": 100, "groupname": "users", "userlist":"", "more_users": "hh", "type": "local" ]
      ],
      "system": $[
        "audio" : $[ "gid": 17, "groupname": "audio", "userlist":"hh", "more_users": "", "type": "local" ]
      ]
    ];

    DUMP ( sformat ("local groups:\n %1\n", Users::groups [ "local" ]:$[]) );

    TEST(``(Users::Commit ("user", false)), [], 0);

    DUMP ( sformat ("local groups modified:\n %1\n",
        Users::groups [ "local" ]:$[]) );

    DUMP ("==========================================================");

    // with rebuilding the cache:
    DUMP ( sformat ("local user itemlist:\n %1",
        UsersCache::users_itemlists [ "local" ]:[]) );

    TEST(``(Users::Commit ("user", true)), [], 0);

    DUMP ( sformat ("local user itemlist modified:\n %1",
        UsersCache::users_itemlists [ "local" ]:[]) );

}
